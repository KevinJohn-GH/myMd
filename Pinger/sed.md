#  sed

### sed基本原理

- sed即为``stream editor``，是一个流式编辑器，本质上是一个程序；
- 流式编辑器用于对输入流执行基本的文本转换操作；
- sed从文件、管道或者标准输入等读取输入流的每一行内容放入模式空间``(pattern space)``；
- sed只能通过一此输入流，即为每次输入流只能被处理一次饭；
- 将输入到模式空间的行的行号通过sed的行号计数器记录在内存中；
- 对模式空间的行进行模式匹配：
  - 当行被预设定的模式匹配上时，则使用sed程序内部的空间进行处理
  - 处理结束后，默认是从模式空间输出，并清空模式空间中的内容
  - 然后在输入流中读取下一行到模式空间进行相同的操作，直到输入流中所有的行都被处理完成
- sed是一个循环接着一个循环去处理内容的

sed的处理流程：

- 第一步：读取输入流的一行到模式空间中
- 第二步：根据预设定的匹配规则，对匹配空间中的内容进行匹配和处理
- 第三步：默认情况下输出发模式空间中处理过到1内容
- 第四步：清空模式空间中的内容
- 第五步：再次循环执行上述几个步骤，直到输入流中的内容全部处理完成

sed自定义命令作用的地方：

- 用户自定义好的sed命令，作用的步骤在第二步，即为可以通过自定义sed命令对模式空间中的内容进行匹配和相应的修改；
- 注意，通过sed命令的选项可以去修改第三步和第四步内容，即为修改被修改过后的在模式空间中长的内容的输入，如修改为输出进空内容，还有不晴空模式空间中的内容等；

### sed程序语法格式

``sed OPTIONS SCRIPT INPUT_STREAM``

##### 对格式中的几个组成部分的说明：

``SCRIPT ``

即为所谓的sed脚本，可以简单理解为是一个sed的内部命令集合，sed的内部命令有些特殊，内部命令包括行匹配和对应要执行的命令；

 ``SCRIPT``的格式是：

- ``ADDR1[,ADDR2...]cmd_list``, 例如山出发某个文件中的第二行内容，命令为``sed 2d filename``
- 注意：在地址后面紧接着命令。地址和命令之间是没有空格的·，如上述例子中。2为地址，d为命令，标书山出发；

``SCRIPT``在sed的处理流程中的位置如下：

- 第一步：读取输入流的一行到模式空间中；
- 第二步：根据预设定的匹配规则，对模式空间中的内容进行匹配和处理，具体为对模式空间中内容执行``SCRIPT``
- 第三步：默认情况下自动输出模式空间中处理过后的内容；
- 第四步：清空模式空间中的内容
- 第五步：再次循环执行上述几个步骤，直到输入流中的内容全部处理完成；

``SCRIPT``部分包含了sed命令行中的内部命令，还包括两个隐含分动作：自动输出处理过后的，模式空间中的内容和清空模式空间的内容；

补充：外层for循环，循环输入流的行。内层SCRIPT循环，循环cmd命令。

 ``SCTIPT``的写法规则：

**一行的方式** ：当有多个命令是，用分号 ";" 隔开即可；当有多个表达式时，表达式之间用分号隔开或者用-e选项去隔开

```
sed ADDR1{cmd1, cdm2, cmd3, cmd4 ...};ADDR2{cmd1, cmd2, cmd3, cmd4}
```
或者
```
sed -e 'ADDR1{cmd1, cdm2, cmd3, cmd4 ...}' -e 'ADDR1{cmd1, cdm2, cmd3, cmd4 ...}'
```

**多行的方式**  ：可以采用分行的写法 

```
sed ADDR1{
	cmd1
	cmd2
	cmd3
	...
}
```

**脚本方式：**

```
# !/usr/bin/sed -f
ADDR1{cmd1; cmd2; cmd3...}
ADDR2{cmd1; cmd2; cmd3...}
...
```
关于cmd的说明：cmd中还可以进行模式匹配，即为类似于``ADDR{{pattern1}cmd1;{pattern2}cmd2...}``，例如：``/^abc/{ad;p}``

### sed程序常用选项

- --version

  输出当前的版本并退出

- -n

  默认情况下sed是会在每次SCRIPT循环结束后，自动输出模式空间中的内容；

  使用-n选项可以将SCRIPT循环中的某次循环，输出空内容，而非输出模式空间中的内容；（通俗理解：只输出匹配的内容）

  注意：不是不输出内容而是输出的内容为空

- -e

  使用-e选项，可以向SCRIPT中添加命令，可以使用-e选项指定多个表达式；

  通俗理解-e选项，即为通过之地那个多个表达式进行多点编辑；

- -f

  -f选项，基本用法是:``-f SCRIPT -FILE``,用于指定包命令集合的SCRIPT文件，让sed可以根据SCRIPT文件中的命令去处理模式空间中的内容；

  在-f选项指定的文件中，每一行就是一个sed命令；

- -i

  默认情况下，使用sed程序对输入流中的内容进行修改，最终会将修改后的內容覆盖原内容，原文件内容不会备份； 

  可以通俗理解：

  - 当-i选项后不带内容，入``sed -i '2d' filename``，则表达实在原处编辑，即为直接修改filename文件；
  - 当-i选项后带内容，如``sed -'_bak' '2d' filename ``，表示在原处编辑前，先对原文件采用重名的方式进行备份``filename_bak``
  - 当扩展名包含一个或者多个星号字符"*"时，则每个星号字符都会被替换成原文件名；

- -r

  默认情况下sed使用的是基本正则表达式，使用-r选项可以指定sed使用扩展的正则表达式；

- -s

  默认情况下，如果输入流为多个独立的文件时，sed会将多个文件当成一个长的输入流，即为所有文件从sed角度来看就是一个大的文件，而非多个文件；

  使用-d选项可以让sed将每个给定的文件作为一个个独立的输入流去处理；



### 1、寻址基础

何为寻址？

寻址即为定位，找到符合某个条件的地方或东西，即为寻址；

 - ``sed SCRIPT`` 中命令有单字符代表的命令和地址组成；
- 地址的作用是匹配当前正在处理的行，如果能匹配成功，就执行与该得知相关联的命令；
  - 地址由定址表达式决定，定址的结果可能是单行，可能是一个范	围，省略定址表达式时表示所有的行；

为何要寻址？

- 当sed将输入流中的行读取到模式空间后，就需要对模式空间中的内容进行匹配，根据匹配结果决定是否执行相对应的命令；

如果匹配：

​	执行相应的命令；

如果不匹配：

​	默认情况下之直接讲模式空间中的内容输出；

​	清空模式空间并进入下一个sed循环读取下一行；

###  2、寻址表达式格式

##### 寻址表达式的基本格式如下：

- ``ADDR1[, ADDR2]``

##### 对于几种可能存在的寻址表达式进行说明：

- 当没有寻址表达式，即为ADDR1、ADDR2都省略，表示多有行都能匹配上（默认输出模式空间中的内容）；
- 省略ADDR2时表示只有ADDR1表达式匹配上的行才符合条件；
- ADDR1和ADDR2都存在时，表示的是一个范围（闭区间），表示从ADDR1匹配成功的行开始，直到ADDR2匹配成功的行结束；

##### 对于ADDR1和ADDR2可使用的匹配方式：

- 都可以使用行号和正则表达式进行位置匹配；


 -  `N`

    - 指定一个行号，sed记那个只匹配指定的行；
    - 注意当输入流十多个文件时，如果不使用-i或者-s选项，则会将所有文件当作成一个大的文件作为一个输入流，只会输出大文件中指定的那N行；
    - 使用-i或-s选项时，sed将会将所有的文件当成一个单独的输入流，能够成功匹配的所有文件横纵的第N行；

- `FIRST~STEP`

  - 表示从第FIRST行开始，每隔STEP行后的行就会被定位，STEP即为步长，例如'2~3',则表示从第二行开始，每隔三行后的行就会被命中，即为2、5、8、、、；
  - 注意：'50~0'表示只取50行；

- `$`

  - 默认情况下，该符号匹配到的是最后一个文件的最后一行，如果使用-s或者-i选项，则匹配到的是每个文件的最后一行；
  - 即为：'$'匹配到的是每个输入流中的最后一行；
  - 注意：不能基于符号'$'使用数学计算的方式进行定址，如'\$-1'这种方式是错误的，'\$'符号只是一个额外的标记符号，当读入到输入流的行，sed发现是最后一行时才会将该行打上符号'\$'

- `/REGEXP/`

  - 将选择能够被正则表达式REGEXP匹配到的所有行；
  - REGEXP即为regular expression；
  - 注意，当正则表达式REGEXP中有字符`/`;

    ​则必须使用反斜杠对字符'/'进行转义，如`\/`

    - 或者使用`%REGEXP%`方式，此时就不需要使用反斜杠对字符`/`		进行转义；
  - 空正则表达式`//`表示引用最后一个正则表达式匹配的结果，例如`sed -n "/2/p;//p" filename `，打印输出第二行两次

-  `/REGEXP/I`或者`%REGEXP%I`

    -  字符`I`表示匹配的时候不区分大小写；

-  `/REGEXP/M`或者`%REGEXP%M`

    - 正则表达式匹配，M表示Multi-lline，即为多行匹配；

    - 只有在模式空间中的有多行，即为模式空间中有换行符的情况下，M修饰符才会生效；

    - 注意：所谓模式空间中有多行，其实看上去是一行，只是一行内容中有`\n`这个换行符；

    - 通过`N`命令可以去实行啊让模式空间中有多行

    - 说明：理解`echo-e "a\nb\nc\nd\n"| sed 'N;2d'` 的输出结果与处理流程

      - 命令N的作用是：
        1. 当执行sed循环即为for循环读取内容时，在执行N命令之前，a这一行已经被读入到模式空间中；
        2. 当把a这一行内容载入到模式空间时，sed程序的行号计数器当前值为1；
        3. 当执行N命令时：
           - 首先不会清空当前模式空间的中的内容，在模式空间的行尾部加上换行符`\n`
           - 然后将第二行内容b在载入到模式空间中，当前模式空间中内容为`a\nb`
           - b载入模式空间后，sed行号计数器数值为2
        4. 2d命令的作用：
           - 当N命令执行完成后，接着执行2d命令。此时行号计数器的值为2,2d命令成功执行，然后模式空间中的内容被清空

    - 不使用M时，^和￥只能匹配pattern space的开始和结尾的位置；

      使用了M时，该修饰符使得正则表达式的元字符^和$分别匹配每个新行后的空字符和新行前的空字符；

      ​

-  `ADDR1, +N`

    匹配到ADDR1和其后的N行；

-  `ADDR1，~N`

    匹配ADDR1**和其后的行** ，直到出现N的倍数行；

    其中，N的倍数要求是：最接近ADDR1且大于ADDR1的正整数即可；

-  `!`

    取反

-  `0,/REGEXP/`

    表示使用0作为起始地址，即为sed程序尝试从第一行开始匹配。如果第一行匹配到，则搜索结束。如果以行号1作为起始地址，则会从第二行开始匹配，直到匹配成功。